---
layout:   post
title:    Установка Linux на компьютер с предустановленной Windows
comments: yes
---

Сегодня многие компьютеры и ноутбуки попадают в руки поклонников Linux
с предустановленной Windows, любезно предоставленной
заводом-изготовителем. Возникает дилемма: удалять или не удалять, и
способ установки уже любимой OS зависит от её решения. Как правило,
изготовитель заранее побеспокоился о том, чтобы установка
дополнительной OS доставила вам множество незабываемых минут, часов,
дней и прочих радостей. Труден путь тех, кто не решился стереть все
воспоминания о Windows с диска, но дорогу осилит идущий.

#+html: <!--more-->

*** Подготовка разделов диска

Способов установки дополнительной системы к Windows мало, поскольку
последняя поддерживает только таблицу разделов [[http://ru.wikipedia.org/wiki/Главная_загрузочная_запись][MBR]], возможности
которой ограничены 4 первичными разделами или 3 первичными и одним
расширенным. Как правило, три первичных раздела уже заняты: один ---
под восстановление системы, и ещё два --- под Windows. Силами Linux
LiveCD и редактора разделов Gparted подвинем полномочия Windows,
уменьшив его раздел, а на освободившемся пространстве создадим раздел
для Linux. Предварительно, полезно ознакомиться с тем, как правильно
[[http://www.linux.org.ru/wiki/en/Выравнивание_разделов_диска][выравнивать разделы диска]]. Если нужна просто рабочая система, не
вдаваясь в ненужные детали, укажите тип раздела как /первичный
(Primary)/, установите Linux на него, а загрузчик Grub --- в MBR
(выбрать установку Grub на весь диск).

Ощутить достоинства Linux с более чем одним подразделом поможет выбор
/расширенного (Extended) раздела/; разбить его можно на разделы для
корневого и домашнего каталогов, а также раздел подкачки (swap).
Просто установить Grub в MBR диска уже не получится, так как в ней нет
сведений о логических разделах. Если вам повезёт, то среди
Windows-разделов найдётся один с файловой системой FAT32, который и
должен быть указан при установке Grub.

[[{{ site.imgdir }}/gparted-partition-table.png][{{ site.imgdir }}/gparted-partition-table.png]]

*** Установка загрузчика на NTFS-раздел

Обратимся к более сложному случаю, когда Windows-разделы имеют тип
файловой системы NTFS, для Grub не подходящей. Установите Grub в
корневой раздел Linux и скопируйте файл настройки
(=/boot/grub/grub.cfg= для Grub 2) в место, доступное из-под Windows.
BIOS будет передавать управление Windows, а уже потом будет грузиться
Grub. Однако, сам по себе Windows не обладает способностью грузить
разделы с файловыми системами Linux. Нам нужен посредник, для чего
можно воспользоваться проектом [[http://sourceforge.net/projects/grub4dos/][Grub For DOS]] или [[http://sourceforge.net/projects/grub2win/][Grub 2 Win]]. Оба они
равноправны, первый создан на основе Grub, второй --- Grub 2. Об
использовании *Grub For DOS* очень обстоятельно рассказано [[http://ru.d-ws.biz/articles/install-ubuntu-from-flash-on-s205.shtml][здесь]], ну а
для пользователей дистрибутивов на основе Grub 2 настоящей находкой
является *Grub 2 Win*, о котором и пойдёт речь дальше.

Установка *Grub 2 Win* очень проста: скачайте архив с сайта и
распакуйте в корень Windows-раздела (обычно, это диск =C=), там должна
появиться папка =C:\grub=. Запустите =C:\grub\install\grub24dos.exe= и
выполните его настройку, после этого инсталлятор добавит новую запись
\laquo{}Grub 2 Win\raquo в меню загрузки Windows. Для наших целей достаточно
выставить /Windows boot timeout/, остальные данные мы позже
продублируем из своего дистрибутива, поместив сохранённый =grub.cfg= в
=C:\grub=. Теперь выбор /Grub 2 Win/ в меню загрузки будет выполнять
переход к Grub 2.

*Примечание.* При любых изменениях, вносимых в конфигурацию Grub\nbsp{}2,
не забывайте обновлять меню, подкладывая *Grub 2 Win* изменённый
=grub.cfg=.

*** Ручная настройка BCD

Наверняка вам известно, что для загрузки, начиная с Windows Vista,
используется [[http://en.wikipedia.org/wiki/Windows_Vista_startup_process#Boot_Configuration_Data][Boot Configuration Data]] (BCD), которую модифицирует *Grub
2 Win*. Для тонкой настройки меню загрузки предназначена консольная
утилита *bcdedit*. Желательно перед любыми изменениями создавать
резервную копию BCD в соответствии с [[http://sourcedaddy.com/windows-7/how-to-back-up-and-restore-settings.html][инструкцией]].

С помощью строки поиска в главном меню Windows найдите интерпретатор
командной строки *cmd* и выберите вариант запуска \laquo{}Run as
administrator\raquo. Используя подробную справку =bcdedit /v= по записям в
BCD, каждой из которых соответствует уникальный GIUD, найдите /Grub 2
Win/. Можно выставить /Grub 2 Win/ первым в меню
#+begin_src bat
  bcdedit /displayorder {GUID} /addfirst
#+end_src
а также сделать пунктом по умолчанию
#+begin_src bat
  bcdedit /default {GUID}
#+end_src
Дальнейшее будет описывать шаги по созданию записи \laquo{}Grub 2 Win\raquo с нуля
на тот случай, если вы пожелаете это сделать самостоятельно. Новая
запись в BCD создаётся командой
#+begin_src bat
  bcdedit /create /d "Grub 2 Win" /application bootsector
#+end_src
После этого будет отображен GUID новой записи, который нужно
подставлять в следующих командах. Укажем раздел, на котором находится
*Grub 2 Win*
#+begin_src bat
  bcdedit /set {GUID} device partition=C:
#+end_src
и местоположение загрузчика
#+begin_src bat
  bcdedit /set {GUID} path \grub\winloader\grub.boot
#+end_src
Новая запись будет добавлена в меню загрузки только после выполнения
команды
#+begin_src bat
  bcdedit /displayorder {GUID} /addfirst
#+end_src
Если =/addfirst= заменить на =/addlast=, то новая запись будет
добавлена в меню загрузки не первой, а последней. Остаётся сделать
запись выбором по умолчанию
#+begin_src bat
  bcdedit /default {GUID}
#+end_src
и установить время ожидания меню
#+begin_src bat
  bcdedit /timeout 5
#+end_src
