---
layout:   post
title:    "Debian и Logical Volume Manager: установка и перенос Linux на другой диск"
comments: yes
---

Ничто так не нарушает привычного комфорта работы в Debian как необходимость изменения разделов на диске с системой. Изначально трудно подобрать разделы так, чтобы избежать их последующего переполнения или неоправданно много пустующего места. Могут быть и другие причины, в силу которых придётся менять разделы на рабочем Linux, что может доставить массу хлопот. Если нет желания проходить через изменение и перенос разделов --- подумайте об установке Linux на LVM.

#+html: <!--more-->

[[http://ru.wikipedia.org/wiki/LVM][LVM]] (/Logical Volume Manager/) представляет собой абстракцию над обычными разделами --- логические тома, изменять которые можно, не отрываясь от работы в Linux. Установка Debian на LVM настолько проста, что вполне по силам и обычному пользователю. Всё, что нужно --- это чистый раздел диска и установочный диск Debian. Желательно к этому моменту иметь опыт установки Linux, поскольку всё описанное --- только мой личный опыт, /без каких-либо гарантий на случай неправильной установки/.

*** В начале установки

Убедитесь, что к компьютеру подключены только те диски, которые будут использоваться в дальнейшем (это позволит инсталлятору правильно настроить загрузчик GRUB2), и загружайтесь с установочного диска. В качестве последнего я выбрал CD для сетевой установки ([[http://www.debian.org/CD/netinst/][netinst]]) с Debian Squeeze на борту, для Debian доступны и [[http://www.debian.org/CD/][другие диски]], установка с которых не должна сильно отличаться. После выбора в меню /GUI Install/, вам будет предложено пройти стандартные шаги установки. Приятно, что можно сразу настроить интернет (при установке с netinst часть пакетов нужно скачать) и русскую локаль с раскладкой.

В разделе /\laquo{}Разметка дисков\raquo/ выбираем /\laquo{}Вручную\raquo/, и далее --- /\laquo{}Настройка менеджера логических томов (LVM)\raquo/:

[[{{ site.imgdir }}/partman_active_partition_0.png][{{ site.imgdir }}/partman_active_partition_0.png]]

*** Настройка менеджера логических томов

Перед настройкой LVM желательно знать о трёх его составляющих:

- Логический том (англ. /logical volume/) --- аналогичен разделу (hda1, sdb3, etc) на не-LVM системах. Так же, как и на них, представляется как блочное устройство и может нести файловую систему.

- Физический том (англ. /physical volume/) --- устройство, представляющееся системе как один диск (жесткий диск или его раздел, RAID-массив).

- Группа томов (англ. /volume group/) --- набор физических томов в один объект.

Настройка начинается с создания группы томов:

[[{{ site.imgdir }}/partman-lvm_mainmenu_0.png][{{ site.imgdir }}/partman-lvm_mainmenu_0.png]]

Я отвёл под группу *debian* весь диск *sda*. Вы можете использовать свои названия групп, в любом сочетании с имеющимися дисками и разделами. Учтите, что /после записи изменений на диск, вся информация на нём будет потеряна/.

*** Создание логических томов

[[{{ site.imgdir }}/partman-lvm_mainmenu_1.png][{{ site.imgdir }}/partman-lvm_mainmenu_1.png]]

Соответствует созданию обычных разделов, среди которых у нас будут:

- /swap/-том (если планируете использовать гибернацию, то он должен быть немного больше размера оперативной памяти);

- корневой том на 10ГБ;

- оставшееся пространство отдадим под директорию =/home= (выделить оставшееся свободное место под том предлагается по умолчанию).

Для примера, поделюсь настройкой корневого тома:

[[{{ site.imgdir }}/partman_choose_partition_0.png][{{ site.imgdir }}/partman_choose_partition_0.png]]

Каждому тому можно задать свой тип файловой системы, точку и опции монтирования.

*** После настройки LVM

Картина расположения томов получилась следующей:

[[{{ site.imgdir }}/partman_choose_partition_1.png][{{ site.imgdir }}/partman_choose_partition_1.png]]

Теперь же вам осталось выбрать зеркала архивов для менеджера пакетов APT, на этом установка Debian завершена.

*** LVM и перенос системы

Текущее состояние LVM можно узнать с помощью команд, выдающих информацию о логических томах: =lvdisplay=; физических томах: =pvdisplay=; и группах томов: =vgdisplay=. В отличие от обычных разделов, операции по изменению LVM-разделов, как правило, проводятся на /живой системе/. Поэтому никогда не следует пренебрегать /золотым правилом безопасности/ --- всегда делать бекапы. LVM хранит данные на свой манер, поэтому задача их восстановления намного сложнее, чем при использовании обычных физических разделов, а порой и вовсе становится неразрешимой.

*Внимание!* Не стоит переносить данные с рабочего раздела, что может [[http://www.celtnet.org.uk/articles/?a=articles&p=1892][обернуться их потерей]]. Отдадим должное LVM, который честно об этом [[http://tldp.org/HOWTO/LVM-HOWTO/removeadisk.html][предупреждает]]: /\laquo{}WARNING: moving of active logical volumes may cause data loss!\raquo/.

Перенос системы на другой диск достигается всего в несколько несложных шагов. Условимся, что =/dev/sda1= --- это раздел с исходной системой, а =/dev/sdb1= --- это новый чистый раздел. Для начала, пустому разделу на новом диске укажем флаг *lvm* (/Gparted \rarr Partition \rarr Manage Flags/) и инициализируем его как физический раздел LVM
#+begin_src console
  # pvcreate /dev/sdb1
#+end_src
Теперь добавим в группу томов *debian*, содержащую переносимый раздел
#+begin_src console
  # vgextend debian /dev/sdb1
#+end_src
Перенесём физические экстенты (/physical extents/), чей размер около 4МБ, с раздела =/dev/sda1= на =/dev/sdb1=:
#+begin_src console
  # pvmove /dev/sda1 /dev/sdb1
#+end_src
Учтите, что операция переноса физических экстентов занимает много времени. Если вы хотите наблюдать за процессом переноса, укажите в команде ключ =-v=. После окончания процедуры, удалите физический том из группы томов
#+begin_src console
  # vgreduce debian /dev/sda1
#+end_src
Теперь старый диск может быть удалён после отключения питания. Дополнительно, данный метод переноса описан в [[http://tldp.org/HOWTO/LVM-HOWTO/removeadisk.html][\laquo{}Removing an Old Disk\raquo]] и [[http://www.nestor.minsk.by/sr/2004/02/40213.html][повести о Linux и LVM]].
